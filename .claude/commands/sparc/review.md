---
description:
  Respond to PR feedback and address review comments using pr-manager agent
argument-hint: [PR number or leave empty to use current branch PR]
allowed-tools: Task
---

# Respond to PR Review

**SPARC Coordinator Role**: This command operates as a pure orchestrator,
delegating all actual work to specialized subagents. The coordinator MUST NOT
perform any direct git, GitHub, or code operations.

## Delegation Strategy

The coordinator delegates to appropriate subagents based on the type of work
needed:

- **pr-manager**: Handles all GitHub PR operations (reading comments, posting
  responses, updating PR status)
- **implementer**: Makes code changes following TDD discipline
  (Red-Green-Refactor)
- **test-hardener**: Strengthens tests if review feedback suggests gaps
- **expert**: Provides architectural guidance for complex feedback

## Pre-Review Setup

**CRITICAL FIRST STEP** (if code changes are needed):

1. **Set Cargo Working Directory**: Call `mcp__cargo__set_working_directory`
   with the absolute path to the project root (where Cargo.toml exists)
2. **Start Bacon Continuous Testing**: Launch `bacon --headless` in background
   for real-time test monitoring
3. **Verify Setup**: Ensure bacon is running for continuous feedback

## Process

1. Delegate to pr-manager to read and analyze all PR comments
2. Based on feedback type, coordinate with appropriate subagents:
   - Code changes â†’ implementer (with TDD discipline)
   - Test improvements â†’ test-hardener
   - Architecture concerns â†’ expert
   - GitHub operations â†’ pr-manager
3. Relay information between subagents as needed
4. Ensure pr-manager responds to comments with proper attribution
5. **ENFORCE MEMORY STORAGE** - Verify all agents store patterns

## Comment Response Format

All responses to PR comments MUST use this format:

```markdown
<!-- Generated by Claude Code -->

**ðŸ¤– Claude Code**: {Your response addressing the specific comment}

{If making code changes, explain what you're doing and why}

_This comment was generated automatically by Claude Code on behalf of the
repository maintainer. Please direct questions about this automation to the
repository owner._
```

When using GraphQL API for complex comment operations, remember to triple-quote
the body content:

```bash
gh api graphql -f query='...' -f input='{"body":"""<!-- Generated by Claude Code -->
**ðŸ¤– Claude Code**: Response content here"""}'
```

## Memory Storage Requirements

**MANDATORY**: All agents involved in review MUST:

- **Search existing patterns**: Use `mcp__qdrant__qdrant-find` for similar issues
- **Store review patterns**: Use `mcp__qdrant__qdrant-store` for:
  - Review feedback patterns
  - Common issues and fixes
  - Implementation strategies
  - Response templates
  - GitHub API interactions

**ENFORCEMENT**: If any agent fails to store knowledge, immediately request they
do so before proceeding.

## Change Implementation Delegation

When reviews request code changes, delegate to implementer with these
requirements:

1. Follow strict TDD discipline (Red-Green-Refactor)
2. **Monitor bacon output** via BashOutput for test status
3. Create focused commits with descriptive messages
4. Include Claude Code attribution in commits:

   ```text
   ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

   Co-Authored-By: Claude <noreply@anthropic.com>
   ```

5. Run full test suite before completion (via bacon)
6. Coordinate with pr-manager to update PR comments after changes

## Information Request Routing

During review response, agents may include "Information Requests" sections. The
coordinator MUST:

1. **Parse Information Requests** from agent responses
2. **Route to Target Agent** using Task tool
3. **Track Requests** to prevent infinite loops (max depth: 3)
4. **Relay Responses** back to requesting agent
5. **Never answer requests directly** - always delegate

Common patterns:

- Implementer â†’ Researcher (for API docs)
- Test-hardener â†’ Expert (for validation)
- PR-manager â†’ Planner (for context)

## PR Review Response Rules

**CRITICAL**: NEVER create top-level comments. Responses must ONLY appear as
threaded replies within review discussions.

Process:

1. **DELETE existing top-level Claude comments first** (via pr-manager)
2. **FIX all issues BEFORE replying** - never say "will fix"
3. **Use correct GraphQL API** for threaded replies
4. **State what was DONE**, not what will be done
5. **Human feedback has priority** over automated suggestions

## Safety Guidelines

**For Coordinator:**

- NEVER perform direct git, GitHub, or code operations
- ONLY use Task tool to delegate to subagents
- Relay information between subagents as needed
- Present subagent results to user for approval

**For Subagents (via delegation):**

- Never mark PR as ready-for-review (pr-manager responsibility)
- Never modify PR back to draft once marked ready-for-review by human
  (pr-manager responsibility)
- Always attribute responses to Claude Code (pr-manager responsibility)
- Make minimal, focused changes only (implementer responsibility)
- Verify all tests pass before completion (implementer responsibility)
- Ask coordinator for clarification on ambiguous feedback

## Critical Rules

- Follow Kent Beck TDD discipline for all code changes
- **Use bacon for continuous testing** - monitor BashOutput for feedback
- Treat clippy warnings as errors (`-- -D warnings`)
- **NEVER** add clippy allow attributes without team approval
- All commits include Claude Code attribution
- **MANDATORY MEMORY STORAGE** - every agent must store knowledge
- **NEVER create top-level PR comments** - only threaded replies
- **FIX issues BEFORE responding** - never promise future fixes
- Human feedback takes priority over automated suggestions

## Example Usage

```bash
/sparc:review 42
```

or

```bash
/sparc:review  # uses current branch PR
```
