RED: Refactoring two large functions using functional composition to eliminate clippy::too_many_lines allows
